# ワタシノセカイト初音ミク 🎤

初音ミクの声でAIと自然な会話ができるシステムです。

**最終更新日: 2025年6月28日**

**⚠️ 重要: 本システムは現在ベータ版です**
- 予期しない動作やエラーが発生する可能性があります
- トラブル発生等による損害について、作者は一切の責任を負いかねます
- 自己責任でのご利用をお願いいたします

## 📋 目次

### 第1章: 一般ユーザー向けガイド 👥
- [🎯 このシステムについて](#このシステムについて)
- [🛠️ 必要なもの](#必要なもの)
- [🚀 セットアップ方法](#セットアップ方法)
- [📖 使い方](#使い方)
- [❓ よくある質問](#よくある質問)
- [🔧 終了方法](#終了方法)
- [🔒 セキュリティ・プライバシー](#セキュリティプライバシー)
- [📞 お問い合わせ・サポート](#お問い合わせサポート)
- [📄 ライセンス](#ライセンス)

### 第2章: 開発者向けガイド 🛠️
- [🤖 AIエージェントシステム概要](#aiエージェントシステム概要)
- [🏗️ 技術スタック](#技術スタック)
- [📁 プロジェクト構造](#プロジェクト構造)
- [🔧 カスタマイズガイド](#カスタマイズガイド)
- [🌐 仕様](#仕様)
- [🐛 デバッグとログ](#デバッグとログ)
- [🧪 テスト](#テスト)

### その他
- [🆘 サポート](#サポート)

---

## 第1章: 一般ユーザー向けガイド 👥

### 🎯 このシステムについて

**「初音ミクと会話しよう！」**

このシステムは、初音ミクの声を使って会話ができるアプリケーションです。

#### ✨ 主な機能
- 🎵 **初音ミクの声で応答**: VOICEVOXとRVCを使用した高品質な音声合成
- 🧠 **記憶機能**: 過去の会話を覚えていて、文脈を理解した応答
- 📎 **ファイル対応**: 画像や音声ファイルを送信して会話に活用
- 📱 **マルチデバイス**: PC、スマートフォンからアクセス可能
- 🌤️ **情報検索**: 天気予報などのリアルタイム情報取得
- ⏰ **無応答リマインダー**: しばらく無言だと話しかけてくれる

#### 🔍 機能の特徴

**🎭 一貫したキャラクター体験**
- どの端末でアクセスしても、起動したPC上の、同じ初音ミクと会話します
- 発話者の区別はそのままだとできません。複数人と会話させたい場合は、文字入力欄に都度誰の発言かを記載してください
- どこからアクセスしても会話の続きができる
- 添付ファイルの内容も含めて記憶し、後の会話で参照

**🎵 高品質な音声体験**
- 途切れない滑らかな音声再生
- 音声生成中でも次の入力が可能
- 思考中は上下に動きます。発話中は緑のエフェクトが出ます。

**⏰ 自然な会話リズム**
- 一定時間無応答だと自動的に話しかけ
- 複数端末使用時も適切な一箇所にのみ通知
- 新しい入力で自動的にリマインダー停止

**📱 使いやすいインターフェース**
- PC・スマホそれぞれに最適化されたレイアウト
- 画像・音声ファイルの簡単添付

**🧠 記憶システム**
- 会話の内容を時系列で記憶し、過去の話題を覚えている
- 添付した画像ファイルの内容も記憶。ただし、もし詳細を思い出せない場合は、再度見せてあげてください

### 🛠️ 必要なもの

#### システム必須要件
- **OS**: Windows 10/11
- **GPU**: NVIDIA GPU（CUDA対応）
- **ネットワーク**: インターネット接続

**⚠️ GPU使用に関する注意**
- ゲームや動画編集ソフト、AIなど、他のGPUを使用するアプリケーションと同時に使用すると、応答が大幅に遅くなります
- GPU使用率が高い状況では、応答できなくなる場合があります
- 快適にご利用いただくため、他のGPU使用アプリケーションを終了してからご使用ください

#### 事前準備（詳細は`install_steps.md`にて）
- **OpenRouter APIアカウント**: 最低5ドル分のクレジット
- **VOICEVOX**: 音声合成エンジン
- **RVC**: リアルタイム音声変換
- **Python 3.13**: プログラミング環境

### 🚀 セットアップ方法

**セットアップ手順は [install_steps.md](install_steps.md) をご覧ください。**



### 📖 使い方

#### 起動方法
1. `system_start.bat` をダブルクリック
2. 複数のウィンドウが開きます（VOICEVOX、RVC、メインシステム）
3. 「Serving Flask app」と表示されたら起動完了

#### アクセス方法
- **PCから**: ブラウザで `http://localhost:5001` を開く
- **スマホから**: 同じWi-Fi内で `http://[PCのIPアドレス]:5001`
- **外出先から**: VPN設定（別途WireGuardなどの設定が必要）により可能

**⚠️ 重要**: システム起動前からページを開いていた場合は、必ず起動後にブラウザにてページをリロード（更新）してください。アクセス端末の管理が正常に行われず、ミクからの応答が再生されなくなります。

#### 基本操作
1. テキストボックスに話したいことを入力
2. 「送信」ボタンをクリック
3. 初音ミクの声で応答が返ってきます
4. 画像を添付して送信することで、初音ミクに写真などを見せることも可能（画像以外は非対応です）

### ❓ よくある質問

#### 音声が出ない場合
- 音声出力デバイスの設定を確認
- VOICEVOXが正常に起動しているか確認
- RVCの設定を再確認

#### スマートフォンからアクセスできない場合
- PCとスマホが同じWi-Fiに接続されているか確認
- ファイアウォールの設定を確認
- PCのIPアドレスを正しく入力しているか確認

#### 初音ミクの声が違う場合
- RVCの音声モデル設定を確認
- 音声モデルファイルが正しく配置されているか確認
- RVCの起動に時間がかかる場合があるので、RVCのGUIが起動したことを確認してからwebサイトを使用してください

### 🔧 終了方法
以下をすべて閉じてください：
- ✅ `system_start.bat` のコマンドプロンプト
- ✅ VOICEVOX
- ✅ RVC のGUIとコマンドプロンプト

### 🔒 セキュリティ・プライバシー

#### データ保存に関する説明
- **会話データの保存場所**: すべてのデータはお使いのPC内のローカルディスクに保存されます
- **保存されるデータ**:
  - 会話履歴（テキスト形式）
  - 記憶データ（ベクトル検索用）
  - 添付画像の文字化データ
- **データの管理**: ファイルは暗号化されていません。PCへの物理的アクセスがある場合は内容を確認できます
- **データの削除**: 上記フォルダを手動で削除することで、すべての会話データを消去できます

#### 外部通信の説明
このシステムは以下の外部サービスと通信します：
- **OpenRouter API**: AI応答生成のため（設定したAPIキーで認証）
- **その他の通信**: 上記以外の外部通信は発生しません

#### プライバシー配慮
- **音声データ**: 生成された音声ファイルは一時フォルダに保存され、次回のシステム起動時に自動削除されます
- **個人情報の収集**: このシステムは個人情報を収集しません
- **データの第三者提供**: 会話データ及び使用ログが外部に送信されることはありません（OpenRouter APIへの応答生成時を除く）


### 📞 お問い合わせ・サポート

#### 各種ご連絡先
以下のお問い合わせは **X（Twitter）**: https://x.com/ChordDotE までご連絡ください：
- 🐛 **不具合報告**
- 📄 **ライセンス許諾に関するご相談**
- ✨ **機能追加のご要望**
- 💬 **その他何でも**

#### SNS投稿について
このシステムを使ってみた様子をSNSに投稿される際は、以下のハッシュタグをご利用ください：

**`#ワタシノセカイト初音ミク`**

みなさんの投稿を楽しみにしています！

### 📄 ライセンス

#### ワタシノセカイト初音ミク 利用許諾契約

**重要**: このソフトウェアを使用する前に、以下の利用許諾契約を必ずお読みください。

##### 📋 適用範囲
本ライセンスは、本配布パッケージに含まれるソースコード、設定ファイル、ドキュメント、画像ファイル等のすべてのファイルに適用されます。

**注意**: 本ライセンスは以下には適用されません：
- VOICEVOX（別途VOICEVOXのライセンスが適用）
- RVC（別途RVCのライセンスが適用）
- 初音ミクキャラクター（クリプトン・フューチャー・メディア株式会社等の権利）
- 外部依存ライブラリ（各ライブラリのライセンスが適用）

##### ✅ 許可される利用

**個人利用**
- 個人での自由な利用
- 個人での改変（配布ファイル内のすべてのファイルが対象）
- 収益化を伴わない配信・投稿（YouTube、X等のSNS投稿を含む）

##### ⚠️ 制限される利用

**商用利用**
以下の行為には事前の書面（XのDMなどでも可）による許可が必要です：
- 金銭を受け取るすべての行動
- YouTube等での収益化配信
- 設置サポートサービス
- サーバー提供サービス
- その他、直接的・間接的に金銭的利益を得る行為

**配布・再配布**
- 改変物の配布：禁止
- 二次配布：禁止
- 商用・非商用を問わず、本ソフトウェアの無許可の再配布は禁止

##### 📞 商用利用許可申請
商用利用をご希望の場合は、以下にご相談ください：
- **X（Twitter）**: https://x.com/ChordDotE

##### ⚖️ 免責事項
- 本ソフトウェアは「現状のまま」提供されます
- 作者は本ソフトウェアの使用により生じたいかなる損害についても責任を負いません
- 本ソフトウェアの動作保証はありません

##### 🏢 第三者権利の尊重
- 本プロジェクトはクリプトン・フューチャー・メディア株式会社等の公式プロジェクトではありません
- 初音ミクキャラクターの利用については、クリプトン・フューチャー・メディア株式会社のガイドラインに従ってください
- VOICEVOX、RVCの利用については、各ソフトウェアのライセンスに従ってください

##### 📅 ライセンス改定
本ライセンスは予告なく改定される場合があります。最新版は本READMEファイルをご確認ください。

**本ソフトウェアを使用することで、上記の利用許諾契約に同意したものとみなされます。**

---

**🎵 あなたの初音ミクと楽しい会話をお楽しみください！ 🎵**

---

## 第2章: 開発者向けガイド 🛠️

### 🤖 AIエージェントシステム概要

このシステムは、LangGraphを使用したノードベースのAIエージェントアーキテクチャを採用しています。

#### 主要特徴
- **ステートフル処理**: 会話の文脈と状態を保持
- **ノードベース設計**: 機能ごとに分離された処理ノード
- **記憶システム**: ベクトル検索による長期記憶と会話履歴管理
- **マルチモーダル対応**: テキスト、画像、音声の統合処理
- **リアルタイム音声合成**: VOICEVOX + RVCによる初音ミクボイス生成

#### 技術的な動作特徴

**セッション・接続管理**
- **単一セッション制**: 全端末で同じエージェントインスタンスと通信
- **マスタータイマー方式**: アクティブセッションのみが無応答リマインダーを受信
- **WebSocket通信**: リアルタイムで音声ファイル生成通知とセッション管理
- **セッション永続化**: UUID生成による一意のセッション識別

**AIエージェント処理**
- **統合ノード**: 全ての処理判断を一箇所で統合的に実行
- **自動再試行**: 処理失敗時に最大10回まで自動再試行（状態復元付き）
- **メッセージ検証**: 各ノードの出力を厳密に検証してデータ整合性を保証
- **状態ログ**: 各ノード処理をPKL/JSON形式で詳細記録

**音声処理システム**
- **プリロード機能**: 音声ファイルを事前読み込みで滑らかな再生を実現
- **キューイング**: 複数音声ファイルの順次再生（インデックス管理）
- **WebSocket通知**: 音声生成完了をリアルタイム通知
- **音声ファイル管理**: 起動時の自動クリーンアップと一時ファイル管理

**記憶・データ管理**
- **二重記憶構造**: Chroma DB（ベクトル検索）+ LangMem記憶DB（時系列）
- **会話履歴**: タイムスタンプ付きテキストファイルによる永続化
- **ファイル添付処理**: 画像・音声ファイルの内容解析と記憶への統合
- **記憶圧縮**: 長期記憶への効率的な情報圧縮と保存

**エラー処理・復旧**
- **状態復元**: エラー時に元の状態に戻して再処理
- **処理時間計測**: 各ノードの処理時間をミリ秒単位で記録
- **詳細ログ**: エラー内容、スタックトレース、状態変化の詳細記録
- **グレースフル停止**: アプリケーション終了時の適切なリソース解放

### 🏗️ 技術スタック

```
Backend Framework: Python 3.13 + Flask + SocketIO
AI/ML Framework: LangGraph + OpenRouter API
Voice Processing: VOICEVOX + RVC (Real-time Voice Conversion)
Frontend: HTML5 + WebRTC + JavaScript
Memory System: Vector Search + Conversation Compression
Database: Chroma DB
```

### 📁 プロジェクト構造

```
miku/
├── src/                           # メインソースコード
│   ├── app.py                    # Flaskアプリケーション
│   ├── agent_main.py             # LangGraphエージェント
│   ├── settings.json             # 設定ファイル
│   ├── models/                   # データモデル
│   │   ├── memory_manager.py     # 記憶管理
│   │   ├── audio_manager.py      # 音声処理
│   │   ├── voice_player_manager.py # 音声再生
│   │   └── webrtc_handler.py     # WebRTC処理
│   ├── nodes/                    # 処理ノード
│   │   ├── unified_response_node.py # 統合応答ノード
│   │   ├── memory_search_node.py    # 記憶検索ノード
│   │   └── weather_search_node.py   # 天気検索ノード
│   ├── utils/                    # ユーティリティ
│   │   ├── path_config.py        # パス設定
│   │   ├── llm_utils.py          # LLM処理
│   │   └── prompt_utils.py       # プロンプト管理
│   ├── templates/                # フロントエンド
│   │   └── index.html            # メインUI
│   ├── conversations/            # 会話履歴ファイル
│   ├── memory/                   # 記憶データ
│   │   ├── chroma_db/            # Chroma DBファイル
│   │   │   ├── chroma.sqlite3    # ベクトルデータベース
│   │   │   └── [UUID]/           # インデックスファイル
│   │   └── langmem_db/           # 言語記憶データベース
│   │       ├── memory_[timestamp].json # 記憶データ（JSON形式）
│   │       └── memory_[timestamp].pkl  # 記憶データ（バイナリ形式）
│   └── temp_voice/              # 一時音声ファイル
├── setup_interactive.bat         # セットアップ用バッチファイル
├── system_start.bat             # システム起動
└── install_steps.md             # 詳細インストール手順
```

#### 記憶システムの詳細
- **会話履歴**: `src/conversations/` - セッションごとのテキスト形式の会話ログ
- **Chroma DB**: `src/memory/chroma_db/` - ベクトル検索用データベース
- **言語記憶**: `src/memory/langmem_db/` - タイムスタンプ付き記憶データ（JSON/PKL形式）

### 🔧 カスタマイズガイド

#### 設定の編集
- `settings.json`: OpenRouter APIキーを設定
- `system_start.bat`: VOICEVOX、RVCのパスを設定

#### 新しいノードの追加

1. **ノードファイルの作成**
```python
# nodes/custom_node.py
def process_custom_node(state):
    # ノード処理ロジック
    return {
        **state,
        "success": True,
        "messages": [...],
        "next_node": "unified_response"
    }
```

2. **ノード情報の登録**
```python
# nodes/registry.py
NODES_INFO = {
    "custom_node": {
        "description": "カスタムノードの説明",
        "capabilities": ["custom_capability"],
        "node_type": "processing"
    }
}
```

3. **グラフへの追加**
```python
# agent_main.py
from nodes.custom_node import process_custom_node

graph_builder.add_node("custom_node", node_wrapper(process_custom_node, "custom_node"))
```

#### プロンプトのカスタマイズ例

```python
# prompts/custom_prompt.txt
あなたは[カスタムキャラクター]です。
以下の特徴を持って応答してください：
- 特徴1
- 特徴2
```

#### 音声設定の変更

RVCに登録するモデルを変えることで、異なる声で発話可能です。

RVCで作りたい声と似た声質のキャラクターをVOICEVOXで選択すると、再現度が上がります。

### 🌐 仕様


#### エージェントの状態管理

```python
class State(TypedDict):
    input_text: str                    # ユーザー入力
    files: List[Dict[str, Any]]        # 添付ファイル
    processed_input: str               # 処理済み入力
    messages: List[BaseMessage]        # メッセージ履歴
    response: str                      # 応答テキスト
    success: bool                      # 処理成功フラグ
    session_file: str                  # セッションファイル
    available_nodes: Dict              # 利用可能ノード
    next_node: str                     # 次のノード
    is_auto_response: bool             # 自動応答フラグ
    is_inactivity_reminder: bool       # 無応答リマインダーフラグ
    inactivity_timeout: int            # タイムアウト秒数
```

### 🐛 デバッグとログ

#### ログファイルの場所
- **状態ログ**: `src/state_logs/session_[timestamp]/`
- **会話履歴**: `src/conversations/session_[timestamp].txt`
- **APIログ**: `src/api_logs/`

#### デバッグモードの有効化
```python
# app.py
socketio.run(app, debug=True, host='0.0.0.0', port=5001)
```

### 🧪 テスト

**注意**: 現在テストファイルは未完成で、現在のシステム動作と不一致のため削除予定です。

### 📝 ドキュメントについて

**注意**: README.md、install_steps.md以外のマークダウンファイルは未完成で、現在のシステム動作と不一致のため削除予定です。
